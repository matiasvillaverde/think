{
  "id" : "F5EC9C58-4FBE-4BD0-B3EF-E4FA4982EE52",
  "requestId" : "90975A0C-8978-47A9-A02C-335BE8AE1BDB",
  "result" : "# Repository Guidelines\n\n## Architecture Principles\n- **Offline-First**: All platforms (Backend, iOS, Android) implement local-first with bidirectional sync\n- **OpenAPI-First**: Backend Zod schemas → `openapi\/openapi.json` → Client types (auto-generated at build time)\n- **Event Sourcing**: Follows\/likes are append-only, playback uses HLC for conflict resolution\n- **Platform Parity**: iOS, Android, Web share same API contract\n- **Platform Support**: iOS 18+, macOS 15+, Android API 28+\n\n## Tech Stack\n- **Backend**: Next.js 15, TypeScript, Supabase (PostgreSQL + Storage), OpenAPI\n- **Generator**: Generator Service, ElevenLabs V3, HLS streaming\n- **iOS\/macOS**: Swift 6.2, SwiftUI, SwiftData, Swift Concurrency\n- **Android**: Kotlin, Room, Ktor, Hilt, Jetpack Compose\n\n## Project Structure & Module Organization\n- `services\/web-api\/` is the Next.js 15 surface\/API. Routes live under `app\/api\/v1`, shared validation in `lib\/schemas`, and supporting scripts in `scripts\/`.\n- `services\/generator\/` streams audio assets through `index.ts`, adapters, and `services\/`. Its spec helpers in `scripts\/generate-openapi.ts` must stay in lockstep with web-api.\n- Mobile apps live in `clients\/android\/` (Kotlin app\/core\/uicomponents) and `clients\/apple-platforms\/` (SwiftUI Nell, NellCore, UIComponents); keep platform assets scoped to their module.\n- `supabase\/` hosts migrations, `Makefile.db`, and seeds, while `openapi\/` stores generated API artifacts.\n\n## OpenAPI Workflow (Critical)\n- **Single Source of Truth**: `openapi\/openapi.json` (generated from backend Zod schemas)\n- **Backend**: Update `services\/web-api\/lib\/schemas\/*.ts` → Run `npm run openapi:generate` → Generates `openapi\/openapi.json`\n- **iOS\/Android**: Types auto-generate at build time from `openapi\/openapi.json` (never commit generated types)\n- **Never manually edit** `openapi\/openapi.json` - always regenerate from backend\n- **Pre-commit**: Spectral linting + breaking change detection runs automatically\n- **Mock Server**: `npm run mock:start` (port 4010) for contract testing\n\n## Environment Variables & Secrets\n- **Infisical is the single source of truth** for all secrets (managed via `infisical run`)\n- **2 committed files**: `.env.test` (mocked APIs for Docker E2E), `.env.example` (template)\n- **4 Infisical environments**: `dev` (local), `staging`, `prod`, `gh-ci`\n- **Environment label**: set `NELL_ENV` in Infisical (`dev\/staging\/prod\/gh-ci`) and `.env.test` for clarity in logs\n- See `CLAUDE.md` for full environment strategy documentation\n\n## Build, Test & Development Commands\n- `make setup` runs prerequisite checks and installs dependencies\n- `make dev` boots the full stack (web-api, generator, Supabase); `make stop\/restart\/logs` handle lifecycle.\n- Service hot reload: run `npm run dev` inside each service.\n- Highlighted checks: `make test-web-api-fast`, `make test-android-unit`, `make test-ios-macos`, and `make openapi-validate`.\n\n## Coding Style & Naming Conventions\n- TypeScript\/JavaScript stays 2-space indented, ES modules, camelCase helpers, PascalCase components, and co-located Zod schemas whose names mirror their OpenAPI tags.\n- Lint with `npm run lint` (web-api) or `npm run lint:env` (generator). Environment access must flow through `config\/services.ts` (never bare `process.env`).\n- Swift\/Kotlin modules follow platform formatters (SwiftLint, SwiftFormat, ktlint) and keep assets inside platform bundles.\n\n## Testing Guidelines\n- **Fast tests**: `make test-all-fast` runs unit + e2e (~5-10 min, no external services needed)\n- **Full tests**: `make test-all` includes integration tests (~20-30 min, requires `make dev` running)\n- **Web API**: `npm run test:unit` (~128ms), `npm run test:e2e` (~1-2 min), `npm run test:integration` (~10-15 min)\n- **Generator**: `npm run type-check`, `npm run openapi:validate` after schema edits\n- **Mobile**: `make test-android-all`, `make test-ios-all`; include device\/OS info in PR notes for failures\n\n## Commit & Pull Request Guidelines\n- Match existing conventional commits (`fix(ci): …`, `refactor(tests): …`, `security: …`). Scope names should mirror top-level folders.\n- A PR must describe impact, link the Linear\/GitHub issue, list commands\/tests run, call out schema, migration, or config changes, and attach screenshots for UI tweaks.\n- Changes affecting shared OpenAPI must regenerate `openapi\/openapi.json`, include the diff, and tag mobile owners.\n\n## Security & Environment Notes\n- Secrets are managed via Infisical; environment variables are consumed through `config\/services.ts` only (never bare `process.env`).\n- Rotating credentials: Update in Infisical dashboard → auto-syncs to Vercel\/Railway\/GitHub.\n\n## Common Issues\n- New local package or service added → Update `ensure-deps` target in root `Makefile` to include `npm install` for the new package\/service\n- Generator `file:` dependency added → Also update `Dockerfile.generator` and `services\/generator\/Dockerfile` to COPY and build the package\n- \"openapi.json is out of date\" → Run `npm run openapi:generate` in `services\/web-api`\n- \"Breaking changes detected\" → Update version in `scripts\/generate-openapi.ts`\n- Integration tests failing → Ensure `make dev` is running\n- iOS\/Android build fails after API change → Clean build, types regenerate automatically\n- Missing OpenAPI types → iOS: check symlink `NellCore\/openapi.yaml`; Android: run `.\/gradlew clean :core:assembleDebug`\n- Parallel dev (Docker): instance 0 reserved for native; use 1–9 and run `bash scripts\/instance-assign.sh` in each worktree.\n\n## Resources\n- Full docs: `CLAUDE.md` (root), `services\/web-api\/CLAUDE.md`, `clients\/apple-platforms\/CLAUDE.md`, `clients\/android\/CLAUDE.md`\n- API docs: http:\/\/localhost:3000\/api\/docs (when backend running)\n- Mock server: http:\/\/localhost:4010 (run `npm run mock:start` in web-api)\n\n## Nell API MCP (nell_api)\nThis repo includes an MCP server that exposes a curated subset of `openapi\/openapi.json` as tools.\n\n### When To Use\n- Automating Flow\/Agent creation, publishing, and runs (including TTS) from an agent\n- Reading back run results (SSE) and episode audio URLs\n\n### How To Use (Common Workflow)\n1. Auth\n   - `auth.status` to see if tokens are set\n   - `auth.login` (stdio transport only) or `auth.set_token` for CI\/non-interactive\n2. Build + publish a flow\n   - Create agents, create\/publish prompt versions\n   - `nell_api.createFlow` then `nell_api.createFlowNode` + `nell_api.createFlowEdge`\n   - Add a metadata subflow node (purpose `episode_metadata`) with a single `node_type: \"metadata\"` agent node\n   - `nell_api.publishFlow`\n3. Run + monitor\n   - Use `nell_api.runFlow` with `run_mode: \"include_media\"` if you want `media_tts` \/ `media_tti` nodes to execute\n   - `host_ids` are only valid when `run_mode: \"include_media\"`\n   - Monitor with `nell_api.getFlowRunStream` (SSE)\n4. Fetch audio\n   - Flow run responses include `episode_id` when an episode is created\n   - Use `nell_api.getEpisodeById` and read `episode.url_lossless` (MP3) \/ `episode.url_streaming` (HLS)\n\n### Practical Gotchas\n- System variable names like `USER_PROMPT` are reserved. Prefer passing `user_prompt` to `runFlow` instead of creating a flow variable named `USER_PROMPT`.\n- `media_tts` nodes must be leaf nodes. They should not have downstream edges.\n- `media_tts` config should set at least `input_key` (upstream node_key) and `model` (e.g. `fal-ai\/elevenlabs\/text-to-dialogue\/eleven-v3`).\n\n### Convenience Tools\nThe MCP server adds a couple of non-OpenAPI helpers:\n- `nell_api.waitForFlowRunCompletion` (polls `getFlowRun` until terminal status)\n- `nell_api.getEpisodeAudioUrlsFromFlowRun` (`flow_run_id` -> `episode_id` -> audio URLs)\n",
  "toolName" : "workspace"
}
